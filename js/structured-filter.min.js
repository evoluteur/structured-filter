/*
   structured-filter 1.0.11
   http://evoluteur.github.io/structured-filter/
   (c) 2016 Olivier Giulieri
*/
!function(a,b){var c={sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sNotContain:"doesn't contain",sFinish:"finishes with",sInList:"any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewCond:"New filter condition",bAddCond:"Add condition",bUpdateCond:"Update condition",bSubmit:"Submit",bCancel:"Cancel"},d={sEqual:"eq",sNotEqual:"ne",sStart:"sw",sContain:"ct",sNotContain:"nct",sFinish:"fw",sInList:"in",sIsNull:"null",sIsNotNull:"nn",sGreater:"gt",sSmaller:"lt",sBetween:"bw"},e={text:"text",bool:"boolean",number:"number",date:"date",time:"time",list:"list"},f=navigator.userAgent.toLowerCase().indexOf("firefox")===-1;a.widget("evol.structFilter",{options:{fields:[],dateFormat:"mm/dd/yy",highlight:!0,buttonLabels:!1,submitButton:!1,submitReady:!1},_create:function(){var b=this.options.buttonLabels,f=this,g=this.element,h='<div class="evo-searchFilters"></div><a class="evo-bNew" href="javascript:void(0)">'+c.bNewCond+"</a>";this.options.submitButton&&(h+='<a class="evo-bSubmit" href="javascript:void(0)">'+c.bSubmit+"</a>"),h+='<div class="evo-editFilter"></div><a class="evo-bAdd" style="display:none;" href="javascript:void(0)">'+c.bAddCond+'</a><a class="evo-bDel" style="display:none;" href="javascript:void(0)">'+c.bCancel+"</a>",this._step=0,g.addClass("structFilter ui-widget-content ui-corner-all").html(h),this.options.submitReady&&(this._hValues=a("<span></span>").appendTo(g)),this.options.submitButton&&(this._bSubmit=g.find(".evo-bSubmit").button({text:b}).on("click",function(a){f.element.trigger("submit.search")})),this._bNew=g.find(".evo-bNew").button({text:b,icons:{secondary:"ui-icon-plusthick"}}).on("click",function(a){f._step<1&&(f._setEditorField(),f._step=1),f._bAdd.find(".ui-button-text").html(c.bAddCond)}),this._bAdd=g.find(".evo-bAdd").button({text:b,icons:{secondary:"ui-icon-check"}}).on("click",function(a){var b=f._getEditorData();f._cFilter?f._enableFilter(b,f.options.highlight):f.addCondition(b),f._removeEditor()}),this._bDel=g.find(".evo-bDel").button({text:b,icons:{secondary:"ui-icon-close"}}).on("click",function(a){f._removeEditor()}),this._editor=g.find(".evo-editFilter").on("change","#field",function(b){b.stopPropagation(),f._step>2&&f._editor.find("#value,#value2,.as-Txt").remove(),f._step>1&&(f._editor.find("#operator").remove(),f._bAdd.hide()),f._step=1;var c=a(b.currentTarget).val();if(""!==c){f._field=f._getFieldById(c);var d=f._type=f._field.type;f._setEditorOperator(),d!=e.list&&d!=e.bool||f._setEditorValue()}else f._field=f._type=null}).on("change","#operator",function(b){b.stopPropagation(),f._operator=a(this).val(),f._step>2&&(f._editor.find("#value,#value2,.as-Txt").remove(),f._bAdd.hide(),f._step=2),f._setEditorValue()}).on("change keyup","#value,#value2",function(b){b.stopPropagation();var c=f._type,g=a(this).val(),h=""!==g||c==e.list||c==e.bool;c==e.number?h=h&&!isNaN(g):f._operator==d.sBetween&&(h=""!==f._editor.find("#value").val()&&""!==f._editor.find("#value2").val()),h?(f._bAdd.button("enable"),13==b.which&&f._bAdd.trigger("click")):f._bAdd.button("disable")}).on("click","#checkAll",function(){var b=a(this),c=b.prop("checked");allChecks=b.siblings().prop("checked",c)}),this._filters=g.find(".evo-searchFilters").on("click","a",function(){f._editFilter(a(this))}).on("click","a .ui-button-icon-secondary",function(b){b.stopPropagation();var c=a(this).parent();c.hasClass("ui-state-disabled")||c.fadeOut("slow",function(){c.remove(),f._triggerChange()})})},_getFieldById:function(a){if(!this._hash){this._hash={};for(var b=this.options.fields,c=0,d=b.length;c<d;c++)this._hash[b[c].id]=b[c]}return this._hash[a]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableFilter(null,!1),this._bNew.removeClass("ui-state-active").show(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),f&&this._bNew.focus(),this._step=0,this._field=this._type=this._operator=null},addCondition:function(b){var c=a('<a href="javascript:void(0)">'+this._htmlFilter(b)+"</a>").prependTo(this._filters).button({icons:{secondary:"ui-icon-close"}}).data("filter",b).fadeIn();return this.options.highlight&&c.effect("highlight"),this._triggerChange(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this},removeCondition:function(a){return this._filters.children().eq(a).remove(),this._triggerChange(),this},_htmlFilter:function(a){var b='<span class="evo-lBold">'+a.field.label+'</span> <span class="evo-lLight">'+a.operator.label+'</span> <span class="evo-lBold">'+a.value.label+"</span>";return a.operator.value==d.sBetween&&(b+='<span class="evo-lLight"> '+c.opAnd+' </span><span class="evo-lBold">'+a.value.label2+"</span>"),b},_enableFilter:function(a,b){this._cFilter&&(this._cFilter.button("enable").removeClass("ui-state-hover ui-state-active"),b&&this._cFilter.effect("highlight"),a?(this._cFilter.data("filter",a).find(":first-child").html(this._htmlFilter(a)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editFilter:function(a){var b=a.data("filter"),e=b.field.value,f=b.operator.value,g=b.value;this._enableFilter(null,!1),this._removeEditor(),this._cFilter=a.button("disable"),this._setEditorField(e),this._setEditorOperator(f),f==d.sBetween?this._setEditorValue(g.value,g.value2):this._setEditorValue(g.value),this._bAdd.find(".ui-button-text").html(c.bUpdateCond),this._step=3},_setEditorField:function(b){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var c=this.options.fields,d='<select id="field"><option value=""></option>',e=0,f=c.length;e<f;e++){var h=c[e];d+=g.inputOption(h.id,h.label)}d+="</select>",this._fList=d}a(this._fList).appendTo(this._editor).focus()}b&&(this._field=this._getFieldById(b),this._type=this._field.type,this._editor.find("#field").val(b)),this._step=1},_setEditorOperator:function(a){var b=this._type;if(this._step<2){var f="";switch(b){case e.list:f+=g.inputHidden("operator",d.sInList),this._operator=d.sInList;break;case e.bool:f+=g.inputHidden("operator",d.sEqual),this._operator=d.sEqual;break;default:switch(f+='<select id="operator"><option value=""></option>',b){case e.date:case e.time:f+=b==e.time?g.inputOption(d.sEqual,c.sAt)+g.inputOption(d.sNotEqual,c.sNotAt):g.inputOption(d.sEqual,c.sOn)+g.inputOption(d.sNotEqual,c.sNotOn),f+=g.inputOption(d.sGreater,c.sAfter)+g.inputOption(d.sSmaller,c.sBefore)+g.inputOption(d.sBetween,c.sBetween);break;case e.number:f+=g.inputOption(d.sEqual,c.sNumEqual)+g.inputOption(d.sNotEqual,c.sNumNotEqual)+g.inputOption(d.sGreater,c.sGreater)+g.inputOption(d.sSmaller,c.sSmaller);break;default:f+=g.inputOption(d.sEqual,c.sEqual)+g.inputOption(d.sNotEqual,c.sNotEqual)+g.inputOption(d.sStart,c.sStart)+g.inputOption(d.sContain,c.sContain)+g.inputOption(d.sNotContain,c.sNotContain)+g.inputOption(d.sFinish,c.sFinish)}f+=g.inputOption(d.sIsNull,c.sIsNull)+g.inputOption(d.sIsNotNull,c.sIsNotNull)+"</select>"}this._editor.append(f)}a&&b!=e.list&&(this._editor.find("#operator").val(a),this._operator=a),this._step=2},_setEditorValue:function(a,b){var f=this._editor,h=this._type,i=f.find("#operator").val(),j=!1,k=!0;if(""!==i){if(h==e.list||i!=d.sIsNull&&i!=d.sIsNotNull){if(this._step<3){var l="";switch(j=i==d.sBetween,h){case e.list:l+='<span id="value">'+(this._field.list.length>7?'(<input type="checkbox" id="checkAll" value="1"/><label for="checkAll">All</label>) ':"")+g.inputCheckboxes(this._field.list)+"</span>";break;case e.bool:l+='<span id="value">'+g.inputRadio("value","1",c.yes,"0"!=a,"value1")+g.inputRadio("value","0",c.no,"0"==a,"value0")+"</span>";break;case e.date:case e.time:case e.number:var m=h==e.date?"text":h;l+='<input id="value" type="'+m+'"/>',j&&(l+='<span class="as-Txt">'+c.opAnd+' </span><input id="value2" type="'+m+'"/>'),k=!1;break;default:l+='<input id="value" type="text"/>',k=!1}f.append(l),h==e.date&&f.find("#value,#value2").datepicker({dateFormat:this.options.dateFormat})}if(a){var n=f.find("#value");switch(h){case e.list:n.find("#"+a.split(",").join(",#")).prop("checked","checked");break;case e.bool:n.find("#value"+a).prop("checked","checked");break;default:n.val(a),k=""!==a,j&&(n.next().next().val(b),k=""!==a&&""!==b)}}else k=h==e.list||h==e.bool}else f.append(g.inputHidden("value",""));this._bAdd.button(k?"enable":"disable").show(),this._step=3}},_getEditorData:function(){var a=this._editor,b=a.find("#field"),f=a.find("#value"),g={field:{label:b.find("option:selected").text(),value:b.val()},operator:{},value:{}},h=g.operator,i=g.value;if(this._type==e.list){var j=[],k=[];f.find("input:checked").not("#checkAll").each(function(){j.push(this.value),k.push(this.nextSibling.innerHTML)}),0===j.length?(h.label=c.sIsNull,h.value=d.sIsNull,i.label=i.value=""):1==j.length?(h.label=c.sEqual,h.value=d.sEqual,i.label='"'+k[0]+'"',i.value=j[0]):(h.label=c.sInList,h.value=d.sInList,i.label="("+k.join(", ")+")",i.value=j.join(","))}else if(this._type==e.bool){h.label=c.sEqual,h.value=d.sEqual;var l=f.find("#value1").prop("checked")?1:0;i.label=1==l?c.yes:c.no,i.value=l}else{var m=a.find("#operator"),n=m.val();h.label=m.find("option:selected").text(),h.value=n,n==d.sIsNull||n==d.sIsNotNull?i.label=i.value="":(this._type==e.number||this._type==e.date||this._type==e.time?i.label=f.val():i.label='"'+f.val()+'"',i.value=f.val(),n==d.sBetween&&(i.label2=i.value2=f.next().next().val()))}return g},_hiddenValue:function(a,b,c){a.push(g.inputHidden("fld-"+c,b.field.value)+g.inputHidden("op-"+c,b.operator.value)+g.inputHidden("val-"+c,b.value.value));var d=b.value.value2;d&&a.push(g.inputHidden("val2-"+c,d))},_setHiddenValues:function(){for(var a=this.val(),b=a.length,c=[g.inputHidden("elem",b)],d=0;d<b;d++)this._hiddenValue(c,a[d],d+1);this._hValues.html(c.join(""))},_triggerChange:function(){this.options.submitReady&&this._setHiddenValues(),this.element.trigger("change.search")},val:function(b){if("undefined"==typeof b){var c=[];return this._filters.find("a").each(function(){c.push(a(this).data("filter"))}),c}this._filters.empty();for(var d=0,e=b.length;d<e;d++)this.addCondition(b[d]);return this._triggerChange(),this},valText:function(){var a=[];return this._filters.find("a").each(function(){a.push(this.text)}),a.join(" "+c.opAnd+" ")},valUrl:function(){var a=this.val(),b=a.length,c="filters="+b;if(b<1)return"";for(var e=0;e<b;e++){var f=a[e];c+="&field-"+e+"="+f.field.value+"&operator-"+e+"="+f.operator.value+"&value-"+e+"="+encodeURIComponent(f.value.value),f.operator.value==d.sBetween&&(c+="&value2-"+e+"="+encodeURIComponent(f.value.value2))}return c+="&label="+encodeURIComponent(this.valText())},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},destroy:function(){var b=this.element.off();b.find(".evo-bNew,.evo-bAdd,.evo-bDel,.evo-searchFilters").off(),this._editor.off(),b.clear().removeClass("structFilter ui-widget-content ui-corner-all"),a.Widget.prototype.destroy.call(this)}});var g={inputRadio:function(a,b,c,d,e){return'<label for="'+e+'"><input id="'+e+'" name="'+a+'" type="radio" value="'+b+(d?'" checked="checked':"")+'">'+c+"</label>&nbsp;"},inputHidden:function(a,b){return'<input type="hidden" name="'+a+'" value="'+b+'"/>'},inputOption:function(a,b){return'<option value="'+a+'">'+b+"</option>"},inputCheckboxes:function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];b+='<input type="checkbox" id="'+d.id+'" value="'+d.id+'"/><label for="'+d.id+'">'+d.label+"</label> "}return b}}}(jQuery);